<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Portfolio Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { overflow-x: hidden; background:#f8f9fa; }
    .holding-card { margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:5px; background:#fff; font-size: 0.95rem; }
    .holding-card ul { padding-left: 15px; margin:0; }
    .card-small { padding: 8px; font-size: 0.95rem; text-align:center; margin-bottom:10px; }
    
    /* Chart container fixes */
    .chart-card { padding:10px; margin-bottom:15px; background:#fff; border-radius:5px; border:1px solid #ddd; }
    .chart-card canvas { width: 100% !important; height: 250px !important; display:block; }

    @media (max-width: 768px) {
      .holding-card, .card-small { font-size: 0.9rem; padding: 8px; }
      .chart-card canvas { height: 200px !important; }
    }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="container py-3">
  <h2 class="mb-3 text-center">Portfolio Analysis</h2>

  <!-- Dynamic Holdings Input -->
  <div class="card mb-4 p-3">
    <h5>Enter Holdings</h5>
    <table class="table table-borderless table-sm" id="holdingsInputTable">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Buy Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-success btn-sm mb-2" id="addRowBtn">Add Stock</button>
    <button class="btn btn-primary btn-sm mb-2" id="submitHoldingsBtn">Analyze Portfolio</button>
  </div>

  <div id="loader" class="text-center my-3" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Summary Cards -->
  <div id="summary" class="row mb-3 text-center"></div>

  <!-- Charts -->
  <div class="row mb-3">
    <div class="col-12 col-md-6">
      <div class="chart-card"><canvas id="niftyChart"></canvas></div>
    </div>
    <div class="col-12 col-md-6">
      <div class="chart-card"><canvas id="sectorChart"></canvas></div>
    </div>
    <div class="col-12 col-md-6">
      <div class="chart-card"><canvas id="holdingChart"></canvas></div>
    </div>
    <div class="col-12 col-md-6">
      <div class="chart-card"><canvas id="topContribChart"></canvas></div>
    </div>
  </div>

  <!-- Holdings Table (Desktop) -->
  <div class="table-responsive d-none d-md-block mb-3">
    <table class="table table-striped table-sm" id="holdingsTable"></table>
  </div>

  <!-- Holdings Card View (Mobile) -->
  <div id="holdingsCards" class="d-block d-md-none mb-3"></div>

  <!-- AI Suggestions -->
  <div id="aiSummary" class="mt-3"></div>

  <h5 class="mt-3">Top Contributors</h5>
  <div id="topList" class="mb-4"></div>

  <div id="rebalanceBlock" class="mt-3" style="display:none;">
    <h4>Rebalance Plan</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-sm" id="rebalanceTable">
        <thead>
          <tr>
            <th>Stock</th>
            <th>Current Weight %</th>
            <th>Target Weight %</th>
            <th>Action</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
let holdingsList = [];
const charts = {};

// Add new input row
function addRow(symbol="", quantity="", buy="") {
  const tbody = document.querySelector("#holdingsInputTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm" value="${symbol}" required></td>
    <td><input type="number" class="form-control form-control-sm" value="${quantity}" required></td>
    <td><input type="number" class="form-control form-control-sm" value="${buy}" required></td>
    <td><button class="btn btn-danger btn-sm removeRowBtn">Ã—</button></td>
  `;
  tbody.appendChild(tr);
  tr.querySelector(".removeRowBtn").addEventListener("click", ()=>tr.remove());
}
addRow();
document.getElementById("addRowBtn").addEventListener("click", ()=>addRow());
document.getElementById("submitHoldingsBtn").addEventListener("click", loadData);

// Render desktop table
function renderHoldingsTable(holdings) {
  let hHtml = `<thead>
  <tr>
    <th>Stock</th><th>Qty</th><th>Price</th><th>Value</th>
    <th>PnL</th><th>Sector</th><th>Key Data</th><th>Corp Actions</th><th>News</th>
  </tr></thead><tbody>`;
  holdings.forEach((h, idx) => {
    const keyData = h.key_data ? `
      <span class="badge bg-primary me-1">PE: ${h.key_data.PE?.toFixed(2) ?? "N/A"}</span>
      <span class="badge bg-success me-1">PB: ${h.key_data.PB?.toFixed(2) ?? "N/A"}</span>
      <span class="badge bg-warning text-dark">DY: ${h.key_data.DividendYield ? (h.key_data.DividendYield*100).toFixed(2)+"%" : "N/A"}</span>
    ` : "N/A";

    const corpHtml = h.corporate_actions?.length
      ? `<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#corp${idx}">View</button>
         <div class="collapse mt-1" id="corp${idx}">
           <ul class="list-unstyled small mb-0">
             ${h.corporate_actions.map(ca => `<li>ðŸ“Œ <b>${ca.type}</b>: ${ca.value} <small>(${ca.date})</small></li>`).join("")}
           </ul>
         </div>`
      : "N/A";

    const newsHtml = h.news?.length
      ? `<ul class="list-unstyled small mb-0">
           ${h.news.slice(0,2).map(n => `<li><a href="${n.link}" target="_blank">${n.title}</a></li>`).join("")}
         </ul>
         ${h.news.length > 2 ? `<a href="#" onclick="toggleNews(${idx});return false;">Show more...</a>` : ""}`
      : "No news";

    const pnlColor = h.pnl >= 0 ? "text-success" : "text-danger";

    hHtml += `<tr>
      <td><b>${h.symbol}</b></td>
      <td>${h.quantity}</td>
      <td>â‚¹${h.price}</td>
      <td>â‚¹${h.value}</td>
      <td class="${pnlColor}">â‚¹${h.pnl} (${h.pnl_percent}%)</td>
      <td>${h.Sector}</td>
      <td>${keyData}</td>
      <td>${corpHtml}</td>
      <td id="newsCell${idx}">${newsHtml}</td>
    </tr>`;
  });
  hHtml += "</tbody>";
  document.getElementById("holdingsTable").innerHTML = hHtml;
}

// Render mobile cards
function renderHoldingsCards(holdings) {
  const container = document.getElementById("holdingsCards");
  container.innerHTML = holdings.map(h => {
    const valueColor = h.value >= h.invested ? "text-success" : "text-danger";
    const pnlColor = h.pnl >= 0 ? "text-success" : "text-danger";
    return `
       <div class="holding-card">
        <strong>${h.symbol}</strong> (${h.Sector})<br>
        Qty: ${h.quantity} | Price: â‚¹${h.price} | Value: â‚¹${h.value}<br>
        PnL: â‚¹${h.pnl} (${h.pnl_percent}%)<br>
        <b>Key:</b> PE ${h.key_data.PE ?? "N/A"}, PB ${h.key_data.PB ?? "N/A"}, DY ${(h.key_data.DividendYield*100).toFixed(2) ?? "N/A"}%<br>
        <b>Actions:</b> ${h.corporate_actions?.map(ca => `${ca.type}: ${ca.value}`).join(", ") || "N/A"}<br>
        <b>News:</b> ${h.news?.map(n => `<a href="${n.link}" target="_blank">${n.title}</a>`).join(", ") || "No news"}
       </div>
    `;
  }).join("");
}

// Retina / High-DPI chart drawing
function createChart(ctx, config) {
  const dpr = window.devicePixelRatio || 1;
  const canvas = ctx.canvas;
  canvas.width = canvas.clientWidth * dpr;
  canvas.height = canvas.clientHeight * dpr;
  const chart = new Chart(ctx, config);
  return chart;
}

function drawPie(id, labels, dataVals, title){
  const ctx = document.getElementById(id).getContext('2d');
  if(charts[id]) charts[id].destroy();
  charts[id] = createChart(ctx, {
    type: 'pie',
    data: { labels: labels, datasets: [{ data: dataVals, backgroundColor: generateColors(dataVals.length) }]},
    options: { responsive:true, maintainAspectRatio:false, plugins:{title:{display:true, text:title}}}
  });
}

function drawBar(id, labels, dataVals, title){
  const ctx = document.getElementById(id).getContext('2d');
  if(charts[id]) charts[id].destroy();
  charts[id] = createChart(ctx, {
    type:'bar',
    data:{ labels: labels, datasets:[{ label:title, data:dataVals, backgroundColor: generateColors(dataVals.length) }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{title:{display:true, text:title}}, scales:{y:{beginAtZero:true}}}
  });
}

function generateColors(n){
  const palette = ['#36a2eb','#ff6384','#ffce56','#4bc0c0','#9966ff','#ff9f40','#8fd19e','#b07aa1','#6fa8dc','#e6b3b3'];
  return Array.from({length:n}).map((_,i)=>palette[i % palette.length]);
}

// Fetch and render data
async function loadData() {
  const tbody = document.querySelector("#holdingsInputTable tbody");
  const rows = tbody.querySelectorAll("tr");
  holdingsList = [];
  rows.forEach(tr=>{
    const inputs = tr.querySelectorAll("input");
    holdingsList.push({
      symbol: inputs[0].value.trim(),
      quantity: parseFloat(inputs[1].value),
      buy: parseFloat(inputs[2].value)
    });
  });
  if(holdingsList.length === 0) return;

  document.getElementById("loader").style.display = "block";
  const res = await fetch("/", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ holdings: holdingsList })
  });
  const data = await res.json();
  document.getElementById("loader").style.display = "none";

  // Summary
  const s = data.summary;
  const pnlColor = s.total_pnl >= 0 ? "text-success" : "text-danger";
  document.getElementById("summary").innerHTML = `
    <div class="col-6 col-md-3"><div class="card card-small">Invested: â‚¹${s.total_invested}</div></div>
    <div class="col-6 col-md-3"><div class="card card-small">Current: â‚¹${s.total_current}</div></div>
    <div class="col-6 col-md-3"><div class="card card-small ${pnlColor}">PnL: â‚¹${s.total_pnl} (${s.total_pnl_percent}%)</div></div>
    <div class="col-6 col-md-3"><div class="card card-small">NIFTY: ${s.nifty_value}</div></div>
  `;

  renderHoldingsTable(data.holdings);
  renderHoldingsCards(data.holdings);

  const top = data.top_contributors || [];
  document.getElementById('topList').innerHTML = top.map(t=>`<div>${t.symbol} â€” â‚¹${t.pnl} (${t.pnl_contribution}%)</div>`).join('');

  drawBar('topContribChart', top.map(t=>t.symbol), top.map(t=>Math.abs(t.pnl_contribution)), 'Top PnL Contribution');

  const sectorLabels = Object.keys(data.sector_alloc || {});
  const sectorValues = Object.values(data.sector_alloc || {});
  drawPie('sectorChart', sectorLabels, sectorValues, 'Sector Allocation');

  drawPie('holdingChart', data.holding_labels||[], data.holding_values||[], 'Holding Allocation');

  // new Chart(document.getElementById("niftyChart").getContext('2d'), {
  //   type: "line",
  //   data: {
  //     labels: data.perf_labels,
  //     datasets: [
  //       {label: "NIFTY", data: data.nifty_series, borderColor: "orange", fill: false, tension:0.2},
  //       {label: "Portfolio", data: data.portfolio_series, borderColor: "green", fill: false, tension:0.2}
  //     ]
  //   },
  //   options: { responsive:true, maintainAspectRatio:false }
  // });
  const niftyCtx = document.getElementById("niftyChart").getContext('2d');
if(charts['niftyChart']) charts['niftyChart'].destroy();
charts['niftyChart'] = createChart(niftyCtx, {
  type: "line",
  data: {
    labels: data.perf_labels,
    datasets: [
      {label: "NIFTY", data: data.nifty_series, borderColor: "orange", fill: false, tension:0.2},
      {label: "Portfolio", data: data.portfolio_series, borderColor: "green", fill: false, tension:0.2}
    ]
  },
  options: { responsive:true, maintainAspectRatio:false }
});

  if (data.ai_summary) {
    const summaryHTML = `
      <div class="card border-info mb-3">
        <div class="card-header bg-info text-white">AI Portfolio Summary</div>
        <div class="card-body">
          <p class="card-text">${data.ai_summary}</p>
        </div>
      </div>
    `;
    document.getElementById("aiSummary").innerHTML = summaryHTML;
  }

  if (data.rebalance && data.rebalance.length > 0) {
    document.getElementById("rebalanceBlock").style.display = "block";
    const tbody = document.querySelector("#rebalanceTable tbody");
    tbody.innerHTML = data.rebalance.map(r => `
      <tr>
        <td>${r.symbol}</td>
        <td>${r.current_weight.toFixed(2)}</td>
        <td>${r.target_weight.toFixed(2)}</td>
        <td>${r.action}</td>
        <td>${r.reason}</td>
      </tr>
    `).join("");
  }
}
</script>

</body>
</html>
